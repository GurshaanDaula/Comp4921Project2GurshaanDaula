<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        <%= thread.title %>
    </title>

    <!-- Global Stylesheet -->
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand shiny-text">DiscussionBoard</a>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/stats" class="nav-link">Stats</a>
                <a href="/threads/new" class="nav-link">New Thread</a>
                <% if (loggedIn) { %>
                    <span class="nav-link">Logged in as <strong>
                            <%= username %>
                        </strong></span>
                    <a href="/logout" class="nav-link">Logout</a>
                    <% } else { %>
                        <a href="/login" class="nav-link">Login</a>
                        <% } %>
            </div>

            <form action="/search" method="GET">
                <input name="q" placeholder="Search..." />
                <button type="submit" class="btn btn-primary">Go</button>
            </form>
        </div>
    </nav>

    <main class="container">
        <!-- Thread Card -->
        <div class="glass-card">
            <div class="thread-header">
                <img src="<%= thread.profile_image %>" alt="Profile Image" />
                <div>
                    <h1 class="thread-title">
                        <%= thread.title %>
                    </h1>
                    <small>By <%= thread.username %> • <%= new Date(thread.created_at).toLocaleString() %></small>
                </div>
            </div>

            <p class="thread-desc">
                <%= thread.description %>
            </p>

            <div class="thread-meta">
                <span><i class="fas fa-eye"></i>
                    <%= thread.views %> Views
                </span>
                <span><i class="fas fa-heart"></i>
                    <%= totalLikes %> Likes
                </span>
                <% if (loggedIn) { %>
                    <button id="like-thread" class="btn <%= thread.user_has_liked ? 'btn-primary' : '' %>">♥ Like
                        thread</button>
                    <% } %>
            </div>
        </div>

        <!-- Comments Section -->
        <section>
            <h2 class="shiny-text">Comments</h2>

            <% if (comments && comments.length) { %>
                <% comments.forEach(c=> { %>
                    <div class="comment-card">
                        <div class="comment-header">
                            <img src="<%= c.profile_image %>" alt="avatar" />
                            <strong>
                                <%= c.username %>
                            </strong>
                            <small>• <%= new Date(c.created_at).toLocaleString() %></small>
                        </div>
                        <div class="comment-content">
                            <%= c.content %>
                        </div>
                        <div class="comment-footer">
                            <% if (loggedIn) { %>
                                <button class="btn btn-like" type="button" data-comment-id="<%= c.comment_id %>">♥
                                    Like</button>
                                <% if (username===c.username) { %>
                                    <a href="/comments/<%= c.comment_id %>/edit" class="btn">Edit</a>
                                    <% } %>
                                        <form class="inline" action="/comments/<%= c.comment_id %>/delete"
                                            method="POST">
                                            <button class="btn btn-outline-danger" type="submit">Delete</button>
                                        </form>
                                        <% } %>
                        </div>
                    </div>
                    <% }) %>
                        <% } else { %>
                            <p>No comments yet.</p>
                            <% } %>

                                <% if (loggedIn) { %>
                                    <form action="/threads/<%= thread.thread_id %>/comments" method="POST">
                                        <textarea name="content" rows="3" placeholder="Write a comment..."
                                            required></textarea>
                                        <button type="submit" class="btn btn-primary" style="margin-top: 0.75rem;">Post
                                            Comment</button>
                                    </form>
                                    <% } else { %>
                                        <p><a href="/login">Log in</a> to post a comment.</p>
                                        <% } %>
        </section>
    </main>

    <footer>
        <p>© 2025 My Forum App. All rights reserved.</p>
    </footer>

    <!-- JavaScript for Like Buttons -->
    <script>
        // Thread like
        document.getElementById("like-thread")?.addEventListener("click", async () => {
            const res = await fetch("/like/<%= thread.thread_id %>", { method: "POST" });
            const data = await res.json();
            if (data && data.success) location.reload();
        });

        // Comment like (delegated)
        document.addEventListener("click", async (e) => {
            const btn = e.target.closest('.btn-like[data-comment-id]');
            if (!btn) return;
            const id = btn.dataset.commentId;

            const res = await fetch(`/comments/${id}/like`, { method: "POST" });
            const data = await res.json();

            if (data && data.success) {
                btn.classList.toggle("btn-primary", data.liked);
                btn.textContent = data.liked ? "♥ Liked" : "♥ Like";
            }
        });
    </script>

</body>

</html>